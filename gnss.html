<!DOCTYPE html>
<!------------------------------------------------------------------------------
* GNSS-Radar
* Copyright (C) 2014-20166 Taro Suzuki <gnsssdrlib@gmail.com>
* history : 2014/07/04 Version 1.0
*           2016/03/14 Version 2.0
* This script uses the following libraries :
*     satellite.js :https://github.com/shashwatak/satellite-js
*     highcharts.js: http://www.highcharts.com/
*     Sylvester.js: http://sylvester.jcoglan.com/
* TLE is downloaded from http://www.celestrak.com/
*------------------------------------------------------------------------------>
<html>
    <head>
        <title>GNSS Radar</title>
        <link rel="shortcut icon" href="/GNSS-Radar/gnssradar/icon/favicon.ico" type="image/vnd.microsoft.ico"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="/GNSS-Radar/gnssradar/gnssradar.css">
        <link rel="stylesheet" href="/GNSS-Radar/gnssradar/lib/datetimepicker/jquery.datetimepicker.css">
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.22"></script>
        <script type="text/javascript" src="/GNSS-Radar/gnssradar/lib/jquery-1.11.3.min.js"></script>
        <script type="text/javascript" src="/GNSS-Radar/gnssradar/lib/highchartsv4/highcharts.js"></script>
        <script type="text/javascript" src="/GNSS-Radar/gnssradar/lib/highchartsv4/modules/exporting.js"></script>
        <script type="text/javascript" src="/GNSS-Radar/gnssradar/lib/highchartsv4/highcharts-more.js"></script>
        <script type="text/javascript" src="/GNSS-Radar/gnssradar/lib/satellite/satellite.js"></script>
        <script type="text/javascript" src="/GNSS-Radar/gnssradar/lib/sylvester/sylvester.js"></script>
        <script type="text/javascript" src="/GNSS-Radar/gnssradar/lib/datetimepicker/jquery.datetimepicker.js"></script>
    </head>
    <body>
        <div id="box1">
            <div id="toolbar">
                <div id="tb_title">
                    <a href="gnssradar_e.html" target="_blank">
                        <img src="/GNSS-Radar/gnssradar/icon/logo.png"/>
                    </a>
                </div>
                <div id="tb_time">
                    Date/Time: <input id="datetimepicker" type="text" style="width:105px; height:12px;">
                    <br/>
                    Lat: <input type="text" id="tb_lat" style="width:56px; height:12px;">
                    Lon: <input type="text" id="tb_lon" style="width:56px; height:12px;">
                    <br/>
                    El. Mask: <input type="text" id="tb_elmask" style="width:25px; height:12px;">
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input id="b_update" type="button" value="update" onClick="JavaScript:update()">
                </div>
                <div id="tb_legend">
                    <div class="row">
                        <div class="cell" id="nsatall"></div>
                        <div class="cell" id="gps"></div>
                        <div class="cell" id="glo"></div>
                        <div class="cell" id="gal"></div>
                        <div class="cell" id="bds"></div>
                        <div class="cell" id="qzs"></div>
                        <div class="cell" id="irns"></div>
                        <div class="cell" id="sbs"></div>
                    </div>
                    <div class="row">
                        <div class="cell" id="nsatallop"></div>
                        <div class="cell">
                            <select id="gpsop" onchange="gpsop(this)" style="width:50px;">
                                <option>ALL</option>
                                <option>L2C</option>
                                <option>L5</option>
                            </select>
                        </div>
                        <div class="cell">
                            <select id="gloop" onchange="gloop(this)" style="width:50px;">
                                <option>M</option>
                                <option>K</option>
                            </select>
                        </div>
                        <div class="cell" id="galop">&nbsp;</div>
                        <div class="cell">
                            <select id="bdsop" onchange="bdsop(this)" style="width:50px;">
                                <option>II</option>
                                <option>III</option>
                            </select>
                        </div>
                        <div class="cell" id="qzsop">&nbsp;</div>
                        <div class="cell" id="irnsop">&nbsp;</div>
                        <div class="cell" id="sbsop">&nbsp;</div>
                    </div>
                </div>
            </div>
            <div id="box2">
                <div id="dop"></div>
                <div id="nsat"></div>
                <div id="sky"></div>
                <div id="map"></div>
            </div>
        </div>
        <script type="text/javascript">
            var map;
            var orglat, orglon, orgllh;
            var orgmarker, infowindow;
            var elemask, offhr;
            var tint;
            var maxntimes = 200;
            var ntimes;
            var tind = 0;
            var time, times = new Array(maxntimes);
            var utcoffset;
            var ngps = 32;
            var nglo = 26;
            var ngal = 30;
            var nbds = 35;
            var nqzs = 7;
            var nirns = 7;
            var nsbs = 23;
            var gpsazels = new Array(maxntimes);
            var gloazels = new Array(maxntimes);
            var galazels = new Array(maxntimes);
            var bdsazels = new Array(maxntimes);
            var qzsazels = new Array(maxntimes);
            var irnsazels = new Array(maxntimes);
            var sbsazels = new Array(maxntimes);
            var gpsllhs = new Array(maxntimes);
            var glollhs = new Array(maxntimes);
            var galllhs = new Array(maxntimes);
            var bdsllhs = new Array(maxntimes);
            var qzsllhs = new Array(maxntimes);
            var irnsllhs = new Array(maxntimes);
            var sbsllhs = new Array(maxntimes);
            var gpsmarkers = new Array(ngps);
            var glomarkers = new Array(nglo);
            var galmarkers = new Array(ngal);
            var bdsmarkers = new Array(nbds);
            var qzsmarkers = new Array(nqzs);
            var irnsmarkers = new Array(nirns);
            var sbsmarkers = new Array(nsbs);
            var gpslines = new Array(ngps);
            var glolines = new Array(nglo);
            var gallines = new Array(ngal);
            var bdslines = new Array(nbds);
            var qzslines = new Array(nqzs);
            var irnslines = new Array(nirns);
            var sbslines = new Array(nsbs);
            var gpstles = new Array(ngps);
            var glotles = new Array(nglo);
            var galtles = new Array(ngal);
            var bdstles = new Array(nbds);
            var qzstles = new Array(nqzs);
            var irnstles = new Array(nirns);
            var sbstles = new Array(nsbs);
            var icongps = new Array(ngps);
            var iconglo = new Array(nglo);
            var icongal = new Array(ngal);
            var iconbds = new Array(nbds);
            var iconqzs = new Array(nqzs);
            var iconirns = new Array(nirns);
            var iconsbs = new Array(nsbs);
            var icon;
            var visstate = {
                "gps": true,
                "glo": true,
                "gal": true,
                "bds": true,
                "qzs": true,
                "irns": true,
                "sbs": true
            };
            var skyplts = {};
            var nsatplts = {};
            var dopplts = {};
            var skychart, nsatchart, dopchart;
            var D2R = Math.PI / 180;
            var R2D = 180 / Math.PI;
            var col = ['rgba(0,128,0,0.5)', 'rgba(255,170,0,0.5)', 'rgba(255,0,255,0.5)', 'rgba(255,0,0,0.5)', 'rgba(0,0,255,0.5)', 'rgba(102,45,145,0.5)', 'rgba(0,128,128,0.5)'];
            var coldark = ['rgba(0,78,0,0.8)', 'rgba(225,140,0,0.8)', 'rgba(205,0,205,0.8)', 'rgba(205,0,0,0.8)', 'rgba(0,0,205,0.8)', 'rgba(82,25,125,0.8)', 'rgba(0,100,100,0.8)'];
            var colhex = ['#008000', '#FFAA00', '#FF00FF', '#FF0000', '#0000FF', '#662D91', '#008080'];

            // get TLE from celestrak.com
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", "gnssradar/celestrak.txt", false);
            xmlHttp.send(null);
            var tledl = xmlHttp.responseText;

            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", "gnssradar/satlist.txt", false);
            xmlHttp.send(null);
            var satlistdl = xmlHttp.responseText;

            var sats = satlistdl.split("\n");
            var nsats = sats.length;

            // parse TLE
            var tles = parse_tle(tledl);

            // sort TLE
            for (var i = 0; i < nsats; i++) {
                var fields = sats[i].split(",");

                if (fields[2]in tles) {
                    var sptle = tles[fields[2]].split(",");

                    // switch satellite type in satlist
                    switch (fields[0]) {
                    case "1":
                        // GPS
                        gpstles[Number(fields[1]) - 1] = {
                            "name": sptle[0],
                            "line1": sptle[1],
                            "line2": sptle[2],
                            "sat": fields[3],
                            "view": true
                        };
                        break;
                    case "2":
                        // SBAS
                        sbstles[Number(fields[1]) - 120] = {
                            "name": sptle[0],
                            "line1": sptle[1],
                            "line2": sptle[2],
                            "sat": fields[3],
                            "view": true
                        };
                        break;
                    case "3":
                        // GLONASS
                        glotles[Number(fields[1]) - 1] = {
                            "name": sptle[0],
                            "line1": sptle[1],
                            "line2": sptle[2],
                            "sat": fields[3],
                            "view": true
                        };
                        break;
                    case "4":
                        // Galileo
                        galtles[Number(fields[1]) - 1] = {
                            "name": sptle[0],
                            "line1": sptle[1],
                            "line2": sptle[2],
                            "sat": fields[3],
                            "view": true
                        };
                        break;
                    case "5":
                        // QZSS
                        qzstles[Number(fields[1]) - 193] = {
                            "name": sptle[0],
                            "line1": sptle[1],
                            "line2": sptle[2],
                            "sat": fields[3],
                            "view": true
                        };
                        break;
                    case "6":
                        // BeiDou
                        bdstles[Number(fields[1]) - 1] = {
                            "name": sptle[0],
                            "line1": sptle[1],
                            "line2": sptle[2],
                            "sat": fields[3],
                            "view": true
                        };
                        break;
                    case "7":
                        // IRNSS
                        irnstles[Number(fields[1]) - 1] = {
                            "name": sptle[0],
                            "line1": sptle[1],
                            "line2": sptle[2],
                            "sat": fields[3],
                            "view": true
                        };
                        break;
                    case "8":
                        // GLONASS-K
                        glotles[Number(fields[1]) - 1] = {
                            "name": sptle[0],
                            "line1": sptle[1],
                            "line2": sptle[2],
                            "sat": fields[3],
                            "view": false
                        };
                        break;
                    case "9":
                        // BeiDou-3
                        bdstles[Number(fields[1]) - 1] = {
                            "name": sptle[0],
                            "line1": sptle[1],
                            "line2": sptle[2],
                            "sat": fields[3],
                            "view": false
                        };
                        break;
                    }
                }
            }
            getoptions();
            googlemap_init();
            initialize();

            $(function() {
                $('#datetimepicker').datetimepicker({
                    value: formatDate(new Date())
                });
            });
            function formatDate(time) {
                var y = time.getFullYear();
                var m = time.getMonth() + 1;
                var d = time.getDate();
                var H = time.getHours();
                var M = time.getMinutes();
                return y + "/" + m + "/" + d + " " + H + ":" + M;
            }
            function invisGPS(n, flag) {
                document.getElementById('gps').innerHTML = '<img onClick="JavaScript:visGPS(' + n + ',true)" src="./gnssradar/icon/gpsicon_.png" /><a class="invis" href="#" onClick="JavaScript:visGPS(' + n + ',true)">GPS(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['gps'] = false;
                    visible_sat_gmap(false, "gps");
                    skychart.series[0].hide();
                    nsatchart.series[0].hide();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                    document.getElementById('gpsop').disabled = true;
                }
                update_nall();
            }
            function invisGLO(n, flag) {
                document.getElementById('glo').innerHTML = '<img onClick="JavaScript:visGLO(' + n + ',true)" src="./gnssradar/icon/gloicon_.png" /><a class="invis" href="#" onClick="JavaScript:visGLO(' + n + ',true)">GLO(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['glo'] = false;
                    visible_sat_gmap(false, "glo");
                    skychart.series[1].hide();
                    nsatchart.series[1].hide();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                    document.getElementById('gloop').disabled = true;
                }
                update_nall();
            }
            function invisGAL(n, flag) {
                document.getElementById('gal').innerHTML = '<img onClick="JavaScript:visGAL(' + n + ',true)" src="./gnssradar/icon/galicon_.png" /><a class="invis" href="#" onClick="JavaScript:visGAL(' + n + ',true)">GAL(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['gal'] = false;
                    visible_sat_gmap(false, "gal");
                    skychart.series[2].hide();
                    nsatchart.series[2].hide();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                }
                update_nall();
            }
            function invisBDS(n, flag) {
                document.getElementById('bds').innerHTML = '<img onClick="JavaScript:visBDS(' + n + ',true)" src="./gnssradar/icon/bdsicon_.png" /><a class="invis" href="#" onClick="JavaScript:visBDS(' + n + ',true)">BDS(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['bds'] = false;
                    visible_sat_gmap(false, "bds");
                    skychart.series[3].hide();
                    nsatchart.series[3].hide();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                    document.getElementById('bdsop').disabled = true;
                }
                update_nall();
            }
            function invisQZS(n, flag) {
                document.getElementById('qzs').innerHTML = '<img onClick="JavaScript:visQZS(' + n + ',true)" src="./gnssradar/icon/qzsicon_.png" /><a class="invis" href="#" onClick="JavaScript:visQZS(' + n + ',true)">QZS(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['qzs'] = false;
                    visible_sat_gmap(false, "qzs");
                    skychart.series[4].hide();
                    nsatchart.series[4].hide();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                }
                update_nall();
            }
            function invisIRNS(n, flag) {
                document.getElementById('irns').innerHTML = '<img onClick="JavaScript:visIRNS(' + n + ',true)" src="./gnssradar/icon/irnsicon_.png" /><a class="invis" href="#" onClick="JavaScript:visIRNS(' + n + ',true)">IRNS(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['irns'] = false;
                    visible_sat_gmap(false, "irns");
                    skychart.series[5].hide();
                    nsatchart.series[5].hide();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                }
                update_nall();
            }
            function invisSBS(n, flag) {
                document.getElementById('sbs').innerHTML = '<img onClick="JavaScript:visSBS(' + n + ',true)" src="./gnssradar/icon/sbsicon_.png" /><a class="invis" href="#" onClick="JavaScript:visSBS(' + n + ',true)">SBS(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['sbs'] = false;
                    visible_sat_gmap(false, "sbs");
                    skychart.series[6].hide();
                    nsatchart.series[6].hide();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                }
                update_nall();
            }
            function visGPS(n, flag) {
                document.getElementById('gps').innerHTML = '<img onClick="JavaScript:invisGPS(' + n + ',true)" src="./gnssradar/icon/gpsicon.png" /><a class="vis" href="#" onClick="JavaScript:invisGPS(' + n + ',true)">GPS(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['gps'] = true;
                    visible_sat_gmap(true, "gps");
                    skychart.series[0].show();
                    nsatchart.series[0].show();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                    document.getElementById('gpsop').disabled = false;
                }
                update_nall();
            }
            function visGLO(n, flag) {
                document.getElementById('glo').innerHTML = '<img onClick="JavaScript:invisGLO(' + n + ',true)" src="./gnssradar/icon/gloicon.png" /><a class="vis" href="#" onClick="JavaScript:invisGLO(' + n + ',true)">GLO(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['glo'] = true;
                    visible_sat_gmap(true, "glo");
                    skychart.series[1].show();
                    nsatchart.series[1].show();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                    document.getElementById('gloop').disabled = false;
                }
                update_nall();
            }
            function visGAL(n, flag) {
                document.getElementById('gal').innerHTML = '<img onClick="JavaScript:invisGAL(' + n + ',true)" src="./gnssradar/icon/galicon.png" /><a class="vis" href="#" onClick="JavaScript:invisGAL(' + n + ',true)">GAL(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['gal'] = true;
                    visible_sat_gmap(true, "gal");
                    skychart.series[2].show();
                    nsatchart.series[2].show();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                }
                update_nall();
            }
            function visBDS(n, flag) {
                document.getElementById('bds').innerHTML = '<img onClick="JavaScript:invisBDS(' + n + ',true)" src="./gnssradar/icon/bdsicon.png" /><a class="vis" href="#" onClick="JavaScript:invisBDS(' + n + ',true)">BDS(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['bds'] = true;
                    visible_sat_gmap(true, "bds");
                    skychart.series[3].show();
                    nsatchart.series[3].show();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                    document.getElementById('bdsop').disabled = false;
                }
                update_nall();
            }
            function visQZS(n, flag) {
                document.getElementById('qzs').innerHTML = '<img onClick="JavaScript:invisQZS(' + n + ',true)" src="./gnssradar/icon/qzsicon.png" /><a class="vis" href="#" onClick="JavaScript:invisQZS(' + n + ',true)">QZS(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['qzs'] = true;
                    visible_sat_gmap(true, "qzs");
                    skychart.series[4].show();
                    nsatchart.series[4].show();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                }
                update_nall();
            }
            function visIRNS(n, flag) {
                document.getElementById('irns').innerHTML = '<img onClick="JavaScript:invisIRNS(' + n + ',true)" src="./gnssradar/icon/irnsicon.png" /><a class="vis" href="#" onClick="JavaScript:invisIRNS(' + n + ',true)">IRNS(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['irns'] = true;
                    visible_sat_gmap(true, "irns");
                    skychart.series[5].show();
                    nsatchart.series[5].show();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                }
                update_nall();
            }
            function visSBS(n, flag) {
                document.getElementById('sbs').innerHTML = '<img onClick="JavaScript:invisSBS(' + n + ',true)" src="./gnssradar/icon/sbsicon.png" /><a class="vis" href="#" onClick="JavaScript:invisSBS(' + n + ',true)">SBS(' + n + ')&nbsp;</a><br/>';
                if (flag) {
                    visstate['sbs'] = true;
                    visible_sat_gmap(true, "sbs");
                    skychart.series[6].show();
                    nsatchart.series[6].show();
                    run_gen_dopplotdata();
                    dopchartdraw(dopplts, times);
                }
                update_nall();
            }
            function update_nall() {
                var nall = 0;
                if (visstate["gps"])
                    nall += nsatplts["gps"][tind].y;

                if (visstate["glo"])
                    nall += nsatplts["glo"][tind].y;

                if (visstate["gal"])
                    nall += nsatplts["gal"][tind].y;

                if (visstate["bds"])
                    nall += nsatplts["bds"][tind].y;

                if (visstate["qzs"])
                    nall += nsatplts["qzs"][tind].y;

                if (visstate["irns"])
                    nall += nsatplts["irns"][tind].y;

                if (visstate["sbs"])
                    nall += nsatplts["sbs"][tind].y;

                document.getElementById('nsatall').innerHTML = 'N=' + nall;
            }
            function update_legend(flag) {
                if (visstate["gps"])
                    visGPS(nsatplts["gps"][tind].y, flag);
                else
                    invisGPS(nsatplts["gps"][tind].y, flag);

                if (visstate["glo"])
                    visGLO(nsatplts["glo"][tind].y, flag);
                else
                    invisGLO(nsatplts["glo"][tind].y, flag);

                if (visstate["gal"])
                    visGAL(nsatplts["gal"][tind].y, flag);
                else
                    invisGAL(nsatplts["gal"][tind].y, flag);

                if (visstate["bds"])
                    visBDS(nsatplts["bds"][tind].y, flag);
                else
                    invisBDS(nsatplts["bds"][tind].y, flag);

                if (visstate["qzs"])
                    visQZS(nsatplts["qzs"][tind].y, flag);
                else
                    invisQZS(nsatplts["qzs"][tind].y, flag);

                if (visstate["irns"])
                    visIRNS(nsatplts["irns"][tind].y, flag);
                else
                    invisIRNS(nsatplts["irns"][tind].y, flag);

                if (visstate["sbs"])
                    visSBS(nsatplts["sbs"][tind].y, flag);
                else
                    invisSBS(nsatplts["sbs"][tind].y, flag);

                update_nall(flag);
            }
            function gpsop(obj) {
                obj.disabled = true;
                for (var i = 0; i < ngps; i++) {
                    if (gpstles[i]) {
                        switch (obj.options[obj.selectedIndex].text) {
                        case "ALL":
                            gpstles[i].view = true;
                            break;
                        case "L2C":
                            if ((gpstles[i].sat.indexOf("IIR-M") != -1) || (gpstles[i].sat.indexOf("IIF") != -1))
                                gpstles[i].view = true;
                            else
                                gpstles[i].view = false;
                            break;
                        case "L5":
                            if (gpstles[i].sat.indexOf("IIF") != -1)
                                gpstles[i].view = true;
                            else
                                gpstles[i].view = false;
                            break;
                        }
                    }
                }
                update();
                obj.disabled = false;
            }
            function gloop(obj) {
                obj.disabled = true;
                for (var i = 0; i < nglo; i++) {
                    if (glotles[i]) {
                        switch (obj.options[obj.selectedIndex].text) {
                        case "M":
                            if (glotles[i].sat.indexOf("K") != -1) {
                                glotles[i].view = false;
                                glomarkers[i].exist = false;
                                glomarkers[i].setIcon(icon);
                            } else {
                                glotles[i].view = true;
                            }
                            break;
                        case "K":
                            if (glotles[i].sat.indexOf("K") != -1) {
                                glotles[i].view = true;
                            } else {
                                glotles[i].view = false;
                                glomarkers[i].exist = false;
                                glomarkers[i].setIcon(icon);
                            }
                            break;
                        }
                    }
                }
                update();
                obj.disabled = false;
            }
            function bdsop(obj) {
                obj.disabled = true;
                for (var i = 0; i < nbds; i++) {
                    if (bdstles[i]) {
                        switch (obj.options[obj.selectedIndex].text) {
                        case "II":
                            if (bdstles[i].sat.indexOf("BEIDOU-3") != -1) {
                                bdstles[i].view = false;
                                bdsmarkers[i].exist = false;
                                bdsmarkers[i].setIcon(icon);
                            } else {
                                glotles[i].view = true;
                            }
                            break;
                        case "III":
                            if (bdstles[i].sat.indexOf("BEIDOU-3") != -1) {
                                bdstles[i].view = true;
                            } else {
                                bdstles[i].view = false;
                                bdsmarkers[i].exist = false;
                                bdsmarkers[i].setIcon(icon);
                            }
                            break;
                        }
                    }
                }
                update();
                obj.disabled = false;
            }
            function update() {
                document.getElementById('b_update').disabled = true;
                elemask = Number(document.getElementById('tb_elmask').value);
                orglat = Number(document.getElementById('tb_lat').value);
                orglon = Number(document.getElementById('tb_lon').value);

                orgllh = {
                    "latitude": orglat / 180 * Math.PI,
                    "longitude": orglon / 180 * Math.PI,
                    "height": 0
                }

                // generate time 
                var time = new Date(document.getElementById('datetimepicker').value);

                var now = new Date();
                var diffday = (now.getTime() - time.getTime()) / (1000 * 3600 * 24)
                if (diffday > 10 || diffday < -10) {
                    alert(now.toLocaleDateString() + " TLE is used to compute satellite locations of " + time.toLocaleDateString());
                }

                for (var i = 0; i < ntimes; i++) {
                    times[i] = new Date(time.getTime());
                    time.setMinutes(time.getMinutes() + tint / 1000 / 60);
                }

                initialize();
                document.getElementById('b_update').disabled = false;

                update_home(orglat, orglon);
            }

            // get options
            function getoptions() {
                // get number of time intervals to display
                ntimes = getKey("ntimes", 24);
                if (ntimes > maxntimes)
                    ntimes = maxntimes;

                // get number of time intervals to display
                tint = getKey("tint", 30);
                tint = tint * 60 * 1000;
                // ms

                // get elevation mask (default: 10 degree)
                elemask = getKey("elemask", 10);

                // get location (default: Tokyo)
                orglat = getKey("lat", 35.7);
                orglon = getKey("lon", 139.8);

                orgllh = {
                    "latitude": orglat / 180 * Math.PI,
                    "longitude": orglon / 180 * Math.PI,
                    "height": 0
                }

                // offset hour
                offhr = getKey("offhr", 0);

                // get current time
                var time = new Date();
                utcoffset = time.getTimezoneOffset();
                time.setHours(time.getHours() + offhr);
                // add offset hour

                var now = new Date();
                var diffday = (now.getTime() - time.getTime()) / (1000 * 3600 * 24)
                if (diffday > 10 || diffday < -10) {
                    alert(now.toLocaleDateString() + " TLE is used to compute satellite locations of " + time.toLocaleDateString());
                }

                // generate time 
                for (var i = 0; i < ntimes; i++) {
                    times[i] = new Date(time.getTime());
                    time.setMinutes(time.getMinutes() + tint / 1000 / 60);
                }
            }

            function update_home(lat, lon) {
                var latlon = new google.maps.LatLng(lat,lon);
                orgmarker.setPosition(latlon);
                title = "Drag and drop me!<br>Lat:" + lat.toFixed(2) + "&nbsp;Lon:" + lon.toFixed(2);
                infowindow.close();
                infowindow = new google.maps.InfoWindow({
                    content: title
                });
                map.panTo(latlon);
            }
            function googlemap_init() {
                // Google Map options
                var myOptions = {
                    zoom: 3,
                    center: new google.maps.LatLng(orglat,orglon),
                    navigationControl: false,
                    mapTypeControl: false,
                    streetViewControl: false,
                    mapTypeId: google.maps.MapTypeId.SATELLITE
                };
                map = new google.maps.Map(document.getElementById('map'),myOptions);

                // Load satellite icons
                icon = new google.maps.MarkerImage('./gnssradar/icon/transparence.png',new google.maps.Size(3,3),new google.maps.Point(0,0),new google.maps.Point(1,1));

                // Display satellite icons at default position
                var latlon = new google.maps.LatLng(0.0,0.0);
                for (var i = 0; i < ngps; i++) {
                    icongps[i] = new google.maps.MarkerImage('./gnssradar/icon/gps' + (i + 1) + '.png',new google.maps.Size(26,26),new google.maps.Point(0,0),new google.maps.Point(13,13));
                    gpsmarkers[i] = new google.maps.Marker({
                        position: latlon,
                        map: map,
                        icon: icon
                    });
                    gpsmarkers[i].setMap(map);
                    gpslines[i] = new google.maps.Polyline({
                        strokeOpacity: 0.0,
                        strokeWeight: 5
                    });
                    gpslines[i].setMap(map);
                }
                for (var i = 0; i < nglo; i++) {
                    iconglo[i] = new google.maps.MarkerImage('./gnssradar/icon/glo' + (i + 1) + '.png',new google.maps.Size(26,26),new google.maps.Point(0,0),new google.maps.Point(13,13));
                    glomarkers[i] = new google.maps.Marker({
                        position: latlon,
                        map: map,
                        icon: icon
                    });
                    glomarkers[i].setMap(map);
                    glolines[i] = new google.maps.Polyline({
                        strokeOpacity: 0.0,
                        strokeWeight: 5
                    });
                    glolines[i].setMap(map);
                }
                for (var i = 0; i < ngal; i++) {
                    icongal[i] = new google.maps.MarkerImage('./gnssradar/icon/gal' + (i + 1) + '.png',new google.maps.Size(26,26),new google.maps.Point(0,0),new google.maps.Point(13,13));
                    galmarkers[i] = new google.maps.Marker({
                        position: latlon,
                        map: map,
                        icon: icon
                    });
                    galmarkers[i].setMap(map);
                    gallines[i] = new google.maps.Polyline({
                        strokeOpacity: 0.0,
                        strokeWeight: 5
                    });
                    gallines[i].setMap(map);
                }
                for (var i = 0; i < nbds; i++) {
                    iconbds[i] = new google.maps.MarkerImage('./gnssradar/icon/bds' + (i + 1) + '.png',new google.maps.Size(26,26),new google.maps.Point(0,0),new google.maps.Point(13,13));
                    bdsmarkers[i] = new google.maps.Marker({
                        position: latlon,
                        map: map,
                        icon: icon
                    });
                    bdsmarkers[i].setMap(map);
                    bdslines[i] = new google.maps.Polyline({
                        strokeOpacity: 0.0,
                        strokeWeight: 5
                    });
                    bdslines[i].setMap(map);
                }
                for (var i = 0; i < nqzs; i++) {
                    iconqzs[i] = new google.maps.MarkerImage('./gnssradar/icon/qzs' + (i + 193) + '.png',new google.maps.Size(26,26),new google.maps.Point(0,0),new google.maps.Point(13,13));
                    qzsmarkers[i] = new google.maps.Marker({
                        position: latlon,
                        map: map,
                        icon: icon
                    });
                    qzsmarkers[i].setMap(map);
                    qzslines[i] = new google.maps.Polyline({
                        strokeOpacity: 0.0,
                        strokeWeight: 5
                    });
                    qzslines[i].setMap(map);
                }
                for (var i = 0; i < nirns; i++) {
                    iconirns[i] = new google.maps.MarkerImage('./gnssradar/icon/irns' + (i + 1) + '.png',new google.maps.Size(26,26),new google.maps.Point(0,0),new google.maps.Point(13,13));
                    irnsmarkers[i] = new google.maps.Marker({
                        position: latlon,
                        map: map,
                        icon: icon
                    });
                    irnsmarkers[i].setMap(map);
                    irnslines[i] = new google.maps.Polyline({
                        strokeOpacity: 0.0,
                        strokeWeight: 5
                    });
                    irnslines[i].setMap(map);
                }
                for (var i = 0; i < nsbs; i++) {
                    iconsbs[i] = new google.maps.MarkerImage('./gnssradar/icon/sbs' + (i + 120) + '.png',new google.maps.Size(26,26),new google.maps.Point(0,0),new google.maps.Point(13,13));
                    sbsmarkers[i] = new google.maps.Marker({
                        position: latlon,
                        map: map,
                        icon: icon
                    });
                    sbsmarkers[i].setMap(map);
                    sbslines[i] = new google.maps.Polyline({
                        strokeOpacity: 0.0,
                        strokeWeight: 5
                    });
                    sbslines[i].setMap(map);
                }

                // original position
                var latlon = new google.maps.LatLng(orglat,orglon);
                orgmarker = new google.maps.Marker({
                    position: latlon,
                    map: map,
                    icon: "./gnssradar/icon/rangerstation.png",
                    shadow: "./gnssradar/icon/rangerstation.shadow.png",
                    draggable: true
                });
                var title = "Drag and drop me!<br>Lat:" + orglat.toFixed(2) + "&nbsp;Lon:" + orglon.toFixed(2);
                infowindow = new google.maps.InfoWindow({
                    content: title
                });
                google.maps.event.addListener(orgmarker, 'click', function() {
                    infowindow.open(map, orgmarker);
                });

                // add marker drag and drop event
                google.maps.event.addListener(orgmarker, 'dragend', function(ev) {
                    // get new location
                    orglat = ev.latLng.lat();
                    orglon = ev.latLng.lng();
                    orgllh = {
                        "latitude": orglat * D2R,
                        "longitude": orglon * D2R,
                        "height": 0
                    }
                    update_home(orglat, orglon);

                    document.getElementById('tb_lat').value = orglat.toFixed(4);
                    document.getElementById('tb_lon').value = orglon.toFixed(4);

                    for (var i = 0; i < ntimes; i++) {
                        run_compute_satazel(i);
                        // re-compute azels
                    }
                    run_gen_skyplotdata(tind);
                    // re-generate plot data
                    run_gen_nsatplotdata();
                    run_gen_dopplotdata();

                    // draw chart
                    skychartdraw(skyplts);
                    nsatchartdraw(nsatplts, times, orgllh, elemask);
                    dopchartdraw(dopplts, times);

                    update_legend(false);
                });
            }

            // initialization function
            function initialize() {
                for (var i = 0; i < ntimes; i++) {
                    run_compute_satllh(i);
                    // compute satellites locations
                    run_compute_satazel(i);
                    // compute satellites azels
                }
                run_set_sat_gmap(tind);
                // set satellites on gmap
                run_visible_sat_gmap();
                // visible satellites on gmap
                run_gen_skyplotdata(tind);
                // generate plot data
                run_gen_nsatplotdata();
                run_gen_dopplotdata();

                // draw chart
                skychartdraw(skyplts);
                nsatchartdraw(nsatplts, times, orgllh, elemask);
                dopchartdraw(dopplts, times);

                update_legend(false);

                // set lat/lon
                document.getElementById('tb_lat').value = orglat.toFixed(4);
                document.getElementById('tb_lon').value = orglon.toFixed(4);
                document.getElementById('tb_elmask').value = elemask.toFixed(0);
                document.getElementById('datetimepicker').value = formatDate(times[tind]);
            }

            // run compute_satllh(ind)
            function run_compute_satllh(ind) {
                gpsllhs[ind] = compute_satllh(gpstles, times[ind]);
                glollhs[ind] = compute_satllh(glotles, times[ind]);
                galllhs[ind] = compute_satllh(galtles, times[ind]);
                bdsllhs[ind] = compute_satllh(bdstles, times[ind]);
                qzsllhs[ind] = compute_satllh(qzstles, times[ind]);
                irnsllhs[ind] = compute_satllh(irnstles, times[ind]);
                sbsllhs[ind] = compute_satllh(sbstles, times[ind]);
            }

            // run set_sat_gmap()
            function run_set_sat_gmap(ind) {
                gpsmarkers = set_sat_gmap(gpsllhs, ind, gpstles, gpsmarkers, 1, colhex[0], gpslines, icongps, visstate['gps']);
                glomarkers = set_sat_gmap(glollhs, ind, glotles, glomarkers, 1, colhex[1], glolines, iconglo, visstate['glo']);
                galmarkers = set_sat_gmap(galllhs, ind, galtles, galmarkers, 1, colhex[2], gallines, icongal, visstate['gal']);
                bdsmarkers = set_sat_gmap(bdsllhs, ind, bdstles, bdsmarkers, 1, colhex[3], bdslines, iconbds, visstate['bds']);
                qzsmarkers = set_sat_gmap(qzsllhs, ind, qzstles, qzsmarkers, 193, colhex[4], qzslines, iconqzs, visstate['qzs']);
                irnsmarkers = set_sat_gmap(irnsllhs, ind, irnstles, irnsmarkers, 1, colhex[5], irnslines, iconirns, visstate['irns']);
                sbsmarkers = set_sat_gmap(sbsllhs, ind, sbstles, sbsmarkers, 120, colhex[6], sbslines, iconsbs, visstate['sbs']);
            }

            // run visible_sat_gmap()
            function run_visible_sat_gmap() {
                visible_sat_gmap(visstate["gps"], "gps");
                visible_sat_gmap(visstate["glo"], "glo");
                visible_sat_gmap(visstate["gal"], "gal");
                visible_sat_gmap(visstate["bds"], "bds");
                visible_sat_gmap(visstate["qzs"], "qzs");
                visible_sat_gmap(visstate["irns"], "irns");
                visible_sat_gmap(visstate["sbs"], "sbs");
            }

            // run compute_satazel()
            function run_compute_satazel(ind) {
                gpsazels[ind] = compute_satazel(orgllh, gpsllhs[ind]);
                gloazels[ind] = compute_satazel(orgllh, glollhs[ind]);
                galazels[ind] = compute_satazel(orgllh, galllhs[ind]);
                bdsazels[ind] = compute_satazel(orgllh, bdsllhs[ind]);
                qzsazels[ind] = compute_satazel(orgllh, qzsllhs[ind]);
                irnsazels[ind] = compute_satazel(orgllh, irnsllhs[ind]);
                sbsazels[ind] = compute_satazel(orgllh, sbsllhs[ind]);
            }

            // run gen_skyplotdata()
            function run_gen_skyplotdata(ind) {
                var gpsplt = gen_skyplotdata("gps", gpsazels[ind], 1);
                var gloplt = gen_skyplotdata("glo", gloazels[ind], 1);
                var galplt = gen_skyplotdata("gal", galazels[ind], 1);
                var bdsplt = gen_skyplotdata("bds", bdsazels[ind], 1);
                var qzsplt = gen_skyplotdata("qzs", qzsazels[ind], 193);
                var irnsplt = gen_skyplotdata("irns", irnsazels[ind], 1);
                var sbsplt = gen_skyplotdata("sbs", sbsazels[ind], 120);
                skyplts = {
                    gps: gpsplt,
                    glo: gloplt,
                    gal: galplt,
                    bds: bdsplt,
                    qzs: qzsplt,
                    irns: irnsplt,
                    sbs: sbsplt
                };
            }

            // run gen_nsatplotdata()
            function run_gen_nsatplotdata() {
                var gpsplt = gen_nsatplotdata(gpsazels);
                var gloplt = gen_nsatplotdata(gloazels);
                var galplt = gen_nsatplotdata(galazels);
                var bdsplt = gen_nsatplotdata(bdsazels);
                var qzsplt = gen_nsatplotdata(qzsazels);
                var irnsplt = gen_nsatplotdata(irnsazels);
                var sbsplt = gen_nsatplotdata(sbsazels);
                nsatplts = {
                    gps: gpsplt,
                    glo: gloplt,
                    gal: galplt,
                    bds: bdsplt,
                    qzs: qzsplt,
                    irns: irnsplt,
                    sbs: sbsplt
                };
            }

            // run gen_nsatplotdata()
            function run_gen_dopplotdata() {
                var dop, hdop = [], vdop = [], pdop = [], gdop = [];
                for (var i = 0; i < ntimes; i++) {
                    dop = compute_dop(i);
                    hdop.push(dop["hdop"]);
                    vdop.push(dop["vdop"]);
                    pdop.push(dop["pdop"]);
                    gdop.push(dop["gdop"]);
                }
                dopplts = {
                    hdop: hdop,
                    vdop: vdop,
                    pdop: pdop,
                    gdop: gdop
                };
            }

            // get additonal inputs
            function getKey(key, def) {
                var str = location.search.substring(1);
                if (str) {
                    var x = str.split("&");
                    for (var i = 0; i < x.length; i++) {
                        var y = x[i].split("=");
                        if (y[0] == key)
                            return Number(y[1]);
                    }
                    return def;
                } else {
                    return def;
                }
            }

            // parse TLE data
            function parse_tle(tleall) {
                var tles = {};
                var tlesplit = tleall.split("\n");
                var ntle = Math.floor(tlesplit.length / 3);
                for (var i = 0; i < ntle; i++) {
                    var satnames = tlesplit[3 * i + 1].split(" ");
                    tles[satnames[1]] = tlesplit[3 * i] + "," + tlesplit[3 * i + 1] + "," + tlesplit[3 * i + 2];
                }
                return tles;
            }

            // compute satellite geodetic location
            function compute_satllh(tles, time) {
                var llhs = new Array(tles.length);
                for (var i = 0; i < tles.length; i++) {
                    if (tles[i] && tles[i].view) {
                        // compute satellite position from TLE
                        llhs[i] = _compute_satllh(tles[i]["line1"], tles[i]["line2"], time);
                    }
                }
                return llhs;
            }
            function _compute_satllh(tle1, tle2, date) {
                var satrec = satellite.twoline2satrec(tle1, tle2);
                var y = date.getUTCFullYear();
                var m = date.getUTCMonth() + 1;
                var d = date.getUTCDate();
                var w = date.getUTCDay();
                var hr = date.getUTCHours();
                var min = date.getUTCMinutes();
                var sec = date.getUTCSeconds();
                var gmst = satellite.gstime_from_date(y, m, d, hr, min, sec);
                var sateci = satellite.propagate(satrec, y, m, d, hr, min, sec);
                return satellite.eci_to_geodetic(sateci["position"], gmst);
            }

            // compute satellite azimuth and elevation
            function compute_satazel(orgllh, llhs) {
                var azels = new Array(llhs.length);
                for (var i = 0; i < llhs.length; i++) {
                    if (llhs[i]) {
                        // azimuth and elevation angle
                        azels[i] = _compute_satazel(orgllh, llhs[i]);
                    }
                }
                return azels;
            }
            function _compute_satazel(orgllh, satllh) {
                var satecf = satellite.geodetic_to_ecf(satllh);
                var azel = satellite.ecf_to_look_angles(orgllh, satecf);
                azel["azimuth"] = azel["azimuth"] / Math.PI * 180;
                // degree
                azel["elevation"] = azel["elevation"] / Math.PI * 180;
                // degree
                return azel;
            }

            // set satellite marker on gmap
            function set_sat_gmap(llhs, ind, tles, markers, prnoffset, color, lines, iconsat, vis) {
                for (var i = 0; i < tles.length; i++) {
                    markers[i].setIcon(icon);
                    markers[i].exist = false;
                    lines[i].setMap(null);
                    if (tles[i] && tles[i].view) {
                        _set_sat_gmap(llhs[ind][i]["latitude"] * R2D, llhs[ind][i]["longitude"] * R2D, tles[i]["name"], i + prnoffset, markers[i]);
                        markers[i].exist = true;

                        if (vis) {
                            markers[i].setIcon(iconsat[i]);
                            var path = new Array(ntimes);
                            for (var j = 0; j < ntimes; j++) {
                                path[j] = new google.maps.LatLng(llhs[j][i]["latitude"] * R2D,llhs[j][i]["longitude"] * R2D);
                            }
                            lines[i] = new google.maps.Polyline({
                                path: path,
                                strokeColor: color,
                                strokeOpacity: 0.4,
                                strokeWeight: 3
                            });
                            lines[i].setMap(map);
                        } else {
                            markers[i].setIcon(icon);
                        }
                    }
                }
                return markers;
            }
            function _set_sat_gmap(lat, lon, svname, prn, marker) {
                var latlon = new google.maps.LatLng(lat,lon);
                marker.setPosition(latlon);

                var title = svname + "<br>PRN:" + prn + "<br>Lat:" + lat.toFixed(2) + "&nbsp;Lon:" + lon.toFixed(2);
                var infowindow = new google.maps.InfoWindow({
                    content: title
                });
                google.maps.event.clearListeners(marker, 'click');
                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.open(map, marker);
                });
            }

            // generate skychart plot data 
            function gen_skyplotdata(sys, azels, offi) {
                var plt = [];
                for (var i = 0; i < azels.length; i++) {
                    if (azels[i]) {
                        if (azels[i]["elevation"] > elemask) {
                            var az = Math.round(azels[i]["azimuth"] * 10) / 10;
                            var el = Math.round(azels[i]["elevation"] * 10) / 10;
                            plt[plt.length] = {
                                name: (i + offi).toString(),
                                x: az,
                                y: el
                            };

                            // GLONASS K
                            if (sys == "glo") {
                                if (i == 24)
                                    plt[plt.length - 1]["name"] = "K1";
                                if (i == 25)
                                    plt[plt.length - 1]["name"] = "K2";
                            }
                        }
                    }
                }
                return plt;
            }
            // generate nsatchart plot data 
            function gen_nsatplotdata(azels) {
                var plt = [];
                for (var j = 0; j < ntimes; j++) {
                    var nsat = 0;
                    for (var i = 0; i < azels[j].length; i++) {
                        if (azels[j][i]) {
                            if (azels[j][i]["elevation"] > elemask) {
                                nsat++;
                            }
                        }
                    }
                    plt[plt.length] = {
                        x: j,
                        y: nsat
                    };
                }
                return plt;
            }
            function check_azel(azels, azs, els) {
                for (var i = 0; i < azels.length; i++) {
                    if (azels[i]) {
                        if (azels[i]["elevation"] > elemask) {
                            azs[azs.length] = azels[i]["azimuth"] * D2R;
                            els[els.length] = azels[i]["elevation"] * D2R;
                        }
                    }
                }
                return [azs, els];
            }
            // compute DOP
            function compute_dop(ind) {
                var azs = [];
                var els = [];
                var tmp;

                // check number of available satellites
                if (visstate["gps"]) {
                    tmp = check_azel(gpsazels[ind], azs, els);
                    azs = tmp[0];
                    els = tmp[1];
                }
                if (visstate["glo"]) {
                    tmp = check_azel(gloazels[ind], azs, els);
                    azs = tmp[0];
                    els = tmp[1];
                }
                if (visstate["gal"]) {
                    tmp = check_azel(galazels[ind], azs, els);
                    azs = tmp[0];
                    els = tmp[1];
                }
                if (visstate["bds"]) {
                    tmp = check_azel(bdsazels[ind], azs, els);
                    azs = tmp[0];
                    els = tmp[1];
                }
                if (visstate["qzs"]) {
                    tmp = check_azel(qzsazels[ind], azs, els);
                    azs = tmp[0];
                    els = tmp[1];
                }
                if (visstate["irns"]) {
                    tmp = check_azel(irnsazels[ind], azs, els);
                    azs = tmp[0];
                    els = tmp[1];
                }
                if (visstate["sbs"]) {
                    tmp = check_azel(sbsazels[ind], azs, els);
                    azs = tmp[0];
                    els = tmp[1];
                }

                var nsat = azs.length;
                if (nsat < 4)
                    return {
                        "hdop": 0,
                        "vdop": 0,
                        "pdop": 0,
                        "gdop": 0
                    };

                var G = Matrix.Zero(nsat, 4);

                for (var i = 0; i < nsat; i++) {
                    G.elements[i][0] = Math.cos(els[i]) * Math.sin(azs[i]);
                    // East
                    G.elements[i][1] = Math.cos(els[i]) * Math.cos(azs[i]);
                    // North
                    G.elements[i][2] = Math.sin(els[i]);
                    // Up
                    G.elements[i][3] = 1;
                }

                var D = (G.transpose().multiply(G)).inverse();
                var out = {};
                out["hdop"] = Math.sqrt(D.elements[0][0] + D.elements[1][1]);
                out["vdop"] = Math.sqrt(D.elements[2][2]);
                out["pdop"] = Math.sqrt(D.elements[0][0] + D.elements[1][1] + D.elements[2][2]);
                out["gdop"] = Math.sqrt(D.elements[0][0] + D.elements[1][1] + D.elements[2][2] + D.elements[3][3]);

                return out;
            }

            // display or non-display satellite icons on gmap
            function visible_sat_gmap(view, sysstr) {
                var markers, lines, iconsat;
                switch (sysstr) {
                case "gps":
                    markers = gpsmarkers;
                    lines = gpslines;
                    iconsat = icongps;
                    break;
                case "glo":
                    markers = glomarkers;
                    lines = glolines;
                    iconsat = iconglo;
                    break;
                case "gal":
                    markers = galmarkers;
                    lines = gallines;
                    iconsat = icongal;
                    break;
                case "bds":
                    markers = bdsmarkers;
                    lines = bdslines;
                    iconsat = iconbds;
                    break;
                case "qzs":
                    markers = qzsmarkers;
                    lines = qzslines;
                    iconsat = iconqzs;
                    break;
                case "irns":
                    markers = irnsmarkers;
                    lines = irnslines;
                    iconsat = iconirns;
                    break;
                case "sbs":
                    markers = sbsmarkers;
                    lines = sbslines;
                    iconsat = iconsbs;
                    break;
                }
                for (var i = 0; i < markers.length; i++) {
                    if (markers[i].exist) {
                        if (view) {
                            markers[i].setIcon(iconsat[i]);
                            lines[i].setMap(map);
                        } else {
                            markers[i].setIcon(icon);
                            // transparence
                            lines[i].setMap(null);
                        }
                    }
                }
            }

            // nsat chart setting
            function nsatchartdraw(nsatplts, times, llh, elemask) {
                var cat = [];

                for (var i = 0; i < ntimes; i++)
                    cat[i] = Highcharts.dateFormat('%H:%M', times[i] - utcoffset * 60 * 1000);

                var plotdata = {
                    chart: {
                        type: 'column',
                        renderTo: 'nsat'
                    },
                    credits: {
                        enabled: false
                    },
                    title: {
                        text: ''
                    },
                    subtitle: {
                        text: ''
                    },
                    xAxis: {
                        type: 'datetime',
                        gridLineWidth: 0,
                        tickmarkPlacement: 'on',
                        categories: cat
                    },
                    yAxis: {
                        gridLineWidth: 0,
                        min: 0,
                        title: {
                            text: 'Number of satellite'
                        },
                        stackLabels: {
                            enabled: true,
                            style: {
                                fontWeight: 'bold',
                                color: 'gray'
                            }
                        }
                    },
                    legend: {
                        enabled: false
                    },
                    tooltip: {
                        formatter: function() {
                            return this.x + '<br/>' + '<b>' + this.series.name + ': ' + this.y + '</b>';
                        },
                        positioner: function() {
                            return {
                                x: 50,
                                y: 50
                            };
                        }
                    },
                    exporting: {
                        scale: 1,
                        sourceHeight: 400,
                        sourceWidth: 800,
                        filename: 'nsat'
                    },
                    plotOptions: {
                        column: {
                            stacking: 'normal',
                            pointPadding: 0,
                            groupPadding: 0,
                            borderWidth: 0,
                            point: {
                                events: {
                                    click: function() {
                                        for (var i = 4; i <= 7; i++) {
                                            dopchart.series[i].data[0].update({
                                                x: this.x,
                                                y: dopchart.series[i - 4].data[this.x].y
                                            }, true, false);
                                        }
                                        for (var i = 0; i < 7; i++) {
                                            nsatchart.series[i].data[tind].update({
                                                color: col[i]
                                            }, true, false);
                                            nsatchart.series[i].data[this.x].update({
                                                color: coldark[i]
                                            }, true, false);
                                        }
                                        tind = this.x;
                                        update_legend(false);
                                        document.getElementById('datetimepicker').value = formatDate(times[tind]);
                                        run_set_sat_gmap(tind);
                                        // set satellites on gmap
                                        run_gen_skyplotdata(tind);
                                        // generate plot data
                                        skychartdraw(skyplts);
                                    }
                                }
                            }
                        }
                    },
                    series: [{
                        name: 'gps',
                        color: col[0]
                    }, {
                        name: 'glo',
                        color: col[1]
                    }, {
                        name: 'gal',
                        color: col[2]
                    }, {
                        name: 'bds',
                        color: col[3]
                    }, {
                        name: 'qzs',
                        color: col[4]
                    }, {
                        name: 'irns',
                        color: col[5]
                    }, {
                        name: 'sbs',
                        color: col[6]
                    }]
                }
                // plotdata

                // set plot data
                plotdata["series"][0]["data"] = nsatplts["gps"];
                plotdata["series"][1]["data"] = nsatplts["glo"];
                plotdata["series"][2]["data"] = nsatplts["gal"];
                plotdata["series"][3]["data"] = nsatplts["bds"];
                plotdata["series"][4]["data"] = nsatplts["qzs"];
                plotdata["series"][5]["data"] = nsatplts["irns"];
                plotdata["series"][6]["data"] = nsatplts["sbs"];

                // set initial visible state
                plotdata["series"][0]["visible"] = visstate["gps"];
                plotdata["series"][1]["visible"] = visstate["glo"];
                plotdata["series"][2]["visible"] = visstate["gal"];
                plotdata["series"][3]["visible"] = visstate["bds"];
                plotdata["series"][4]["visible"] = visstate["qzs"];
                plotdata["series"][5]["visible"] = visstate["irns"];
                plotdata["series"][6]["visible"] = visstate["sbs"];

                for (var i = 0; i < 7; i++)
                    plotdata["series"][i]["data"][tind].color = coldark[i];

                // chart generation
                nsatchart = new Highcharts.Chart(plotdata);
            }

            // DOP chart setting
            function dopchartdraw(dopplts, times) {
                var cat = [];

                for (var i = 0; i < ntimes; i++)
                    cat[i] = Highcharts.dateFormat('%H:%M', times[i] - utcoffset * 60 * 1000);

                var plotdata = {
                    chart: {
                        animation: false,
                        type: 'column',
                        renderTo: 'dop'
                    },
                    credits: {
                        enabled: false
                    },
                    title: {
                        text: ''
                    },
                    legend: {
                        align: 'left',
                        verticalAlign: 'top',
                        floating: true,
                        x: 30,
                        y: 0
                    },
                    xAxis: {
                        type: 'datetime',
                        gridLineWidth: 1,
                        gridLineDashStyle: 'dot',
                        tickmarkPlacement: 'on',
                        categories: cat
                    },
                    yAxis: {
                        lineWidth: 1,
                        tickWidth: 1,
                        gridLineDashStyle: 'dot',
                        tickmarkPlacement: 'on',
                        min: 0,
                        title: {
                            enabled: false
                        }
                    },
                    tooltip: {
                        crosshairs: true,
                        hideDelay: 0,
                        formatter: function() {
                            return this.x + '<br/>' + '<b>' + this.series.name + ': ' + this.y.toFixed(2) + '</b>';
                        }
                    },
                    exporting: {
                        scale: 1,
                        sourceHeight: 400,
                        sourceWidth: 800,
                        filename: 'dop'
                    },
                    plotOptions: {
                        series: {
                            animation: false,
                            lineWidth: 3,
                            marker: {
                                symbol: 'circle',
                                enabled: false
                            },
                            events: {
                                legendItemClick: function() {
                                    return false;
                                }
                            },
                            point: {
                                events: {
                                    click: function() {
                                        for (var i = 4; i <= 7; i++) {
                                            dopchart.series[i].data[0].update({
                                                x: this.x,
                                                y: dopchart.series[i - 4].data[this.x].y
                                            }, true, false);
                                        }
                                        for (var i = 0; i < 7; i++) {
                                            nsatchart.series[i].data[tind].update({
                                                color: col[i]
                                            }, true, false);
                                            nsatchart.series[i].data[this.x].update({
                                                color: coldark[i]
                                            }, true, false);
                                        }
                                        tind = this.x;
                                        update_legend(false);
                                        document.getElementById('datetimepicker').value = formatDate(times[tind]);
                                        run_set_sat_gmap(tind);
                                        // set satellites on gmap
                                        run_gen_skyplotdata(tind);
                                        // generate plot data
                                        skychartdraw(skyplts);
                                    }
                                }
                            }
                        }
                    },
                    series: [{
                        type: 'line',
                        name: 'HDOP',
                        color: col[0]
                    }, {
                        type: 'line',
                        name: 'VDOP',
                        color: col[1]
                    }, {
                        type: 'line',
                        name: 'PDOP',
                        color: col[2]
                    }, {
                        type: 'line',
                        name: 'GDOP',
                        color: col[3]
                    }, {
                        type: 'line',
                        name: 'HDOP',
                        color: col[0],
                        showInLegend: false,
                        data: [{
                            x: tind,
                            y: dopplts["hdop"][tind],
                            marker: {
                                enabled: true,
                                radius: 6,
                                states: {
                                    hover: {
                                        enabled: false
                                    }
                                }
                            }
                        }]
                    }, {
                        type: 'line',
                        name: 'VDOP',
                        color: col[1],
                        showInLegend: false,
                        data: [{
                            x: tind,
                            y: dopplts["vdop"][tind],
                            marker: {
                                enabled: true,
                                radius: 6,
                                states: {
                                    hover: {
                                        enabled: false
                                    }
                                }
                            }
                        }]
                    }, {
                        type: 'line',
                        name: 'PDOP',
                        color: col[2],
                        showInLegend: false,
                        data: [{
                            x: tind,
                            y: dopplts["pdop"][tind],
                            marker: {
                                enabled: true,
                                radius: 6,
                                states: {
                                    hover: {
                                        enabled: false
                                    }
                                }
                            }
                        }]
                    }, {
                        type: 'line',
                        name: 'GDOP',
                        color: col[3],
                        showInLegend: false,
                        data: [{
                            x: tind,
                            y: dopplts["gdop"][tind],
                            marker: {
                                enabled: true,
                                radius: 6,
                                states: {
                                    hover: {
                                        enabled: false
                                    }
                                }
                            }
                        }]
                    }]
                }

                // set plot data
                plotdata["series"][0]["data"] = dopplts["hdop"];
                plotdata["series"][1]["data"] = dopplts["vdop"];
                plotdata["series"][2]["data"] = dopplts["pdop"];
                plotdata["series"][3]["data"] = dopplts["gdop"];

                // chart generation
                dopchart = new Highcharts.Chart(plotdata);
            }

            // sky chart setting
            function skychartdraw(skyplts) {
                var labels = {
                    "0": "N",
                    "45": "NE",
                    "90": "E",
                    "135": "SE",
                    "180": "S",
                    "225": "SW",
                    "270": "W",
                    "315": "NW"
                }

                var plotdata = {
                    chart: {
                        renderTo: "sky",
                        polar: true
                    },
                    credits: {
                        enabled: false
                    },
                    title: {
                        text: ''
                    },
                    subtitle: {
                        text: ''
                    },
                    legend: {
                        enabled: false
                    },
                    tooltip: {
                        pointFormat: 'PRN: <b>{point.name}</b><br>EL: <b>{point.y}</b>deg<br>AZ: <b>{point.x}</b>deg',
                        hideDelay: 0
                    },
                    pane: {
                        startAngle: 0,
                        endAngle: 360
                    },
                    xAxis: {
                        tickInterval: 45,
                        min: 0,
                        max: 360,
                        labels: {
                            formatter: function() {
                                return labels[this.value]
                            },
                            style: {
                                fontSize: 'medium'
                            }
                        }
                    },
                    yAxis: {
                        min: 0,
                        max: 90,
                        minorTickInterval: 10,
                        tickInterval: 30,
                        reversed: true,
                        labels: {
                            enabled: false
                        }
                    },
                    exporting: {
                        scale: 1,
                        sourceHeight: 600,
                        sourceWidth: 600,
                        filename: 'skyplot'
                    },
                    plotOptions: {
                        bubble: {
                            minSize: 28,
                            maxSize: 28,
                            dataLabels: {
                                enabled: true,
                                formatter: function() {
                                    return this.point.name
                                },
                                y: 2,
                                style: {
                                    fontWeight: 'bold',
                                    fontSize: 'medium'
                                },
                                allowOverlap: 'true'
                            },
                            tooltip: {
                                followPointer: false,
                                followTouchMove: false,
                                hideDelay: 0,
                            }
                        }
                    },
                    series: [{
                        type: 'bubble',
                        color: colhex[0],
                        pointPlacement: 'between'
                    }, {
                        type: 'bubble',
                        color: colhex[1],
                        pointPlacement: 'between'
                    }, {
                        type: 'bubble',
                        color: colhex[2],
                        pointPlacement: 'between'
                    }, {
                        type: 'bubble',
                        color: colhex[3],
                        pointPlacement: 'between'
                    }, {
                        type: 'bubble',
                        color: colhex[4],
                        pointPlacement: 'between'
                    }, {
                        type: 'bubble',
                        color: colhex[5],
                        pointPlacement: 'between'
                    }, {
                        type: 'bubble',
                        color: colhex[6],
                        pointPlacement: 'between'
                    }]
                }
                // plotdata

                // set plot data
                plotdata["series"][0]["data"] = skyplts["gps"];
                plotdata["series"][1]["data"] = skyplts["glo"];
                plotdata["series"][2]["data"] = skyplts["gal"];
                plotdata["series"][3]["data"] = skyplts["bds"];
                plotdata["series"][4]["data"] = skyplts["qzs"];
                plotdata["series"][5]["data"] = skyplts["irns"];
                plotdata["series"][6]["data"] = skyplts["sbs"];

                // set initial visible state
                plotdata["series"][0]["visible"] = visstate["gps"];
                plotdata["series"][1]["visible"] = visstate["glo"];
                plotdata["series"][2]["visible"] = visstate["gal"];
                plotdata["series"][3]["visible"] = visstate["bds"];
                plotdata["series"][4]["visible"] = visstate["qzs"];
                plotdata["series"][5]["visible"] = visstate["irns"];
                plotdata["series"][6]["visible"] = visstate["sbs"];

                // chart generation
                skychart = new Highcharts.Chart(plotdata);
            }
        </script>
    </body>
</html>
